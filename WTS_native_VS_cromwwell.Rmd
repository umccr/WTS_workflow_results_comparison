---
title: "bcbio Native versus Cromwell results comparison"
author: "Sehrish Kanwal"
date: "`r format(Sys.time(), '%a %Y-%b-%d')`"
output:
  html_document:
    css: style.css
    theme: readable
    toc: true
    toc_float: true
    code_folding: hide
  rmdformats::material:
    highlight: kate
params:
  run_1: '/Users/kanwals/Documents/UMCCR/data/WTS_comparison/CCR180072_VPT_WH16/bcbio_native/run_1'
  run_2: '/Users/kanwals/Documents/UMCCR/data/WTS_comparison/CCR180072_VPT_WH16/bcbio_cromwell/run_1'
---

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

For each output type (e.g. counts, abundances, fusions), the document currently reports:

- File names in the input (parms) directories
- The number of entries/lines
- The difference between both outputs in a tabular format

</div>


```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE) # global setup
```


```{r define_functions, comment=NA, message=FALSE, warning=FALSE}
### Define functions.
###list files in a directory
lf <- function(...) {
  data.frame(fname = list.files(...)) %>% 
    knitr::kable(row.names = TRUE)
}

###count number of lines in a file
countLines <- function(file_names) {
  target_file <- data.frame(matrix(ncol = length(counts_file_name), nrow = 0))

  for (i in 1:length(file_names)) {
    if (file_ext(file_names[i]) == 'counts') {
      file <- read.table(file_names[i], sep="\t", as.is=TRUE, header=FALSE)
    } else {
      file <- read.table(file_names[i], sep="\t", as.is=TRUE, header=TRUE)
    }
    #count lines
    target_file <- rbind(target_file, data.frame(basename(file_names[i]), nrow(file)))
  }
  colnames(target_file) <- c("file", "lines_count")
  return(target_file)
}

###return different between input files
diffFiles <- function(file_names) {
  #an anti join returns the rows of the first table where it cannot find a match in the second table.
  #also pass a character vector of variables to join by.
  if (stringr::str_detect(file_names[1], pattern = 'counts$')) {
    
    input1 <- read.table(file_names[1], sep="\t", as.is=TRUE, header=FALSE)
    colnames(input1) <- c('gene_id', 'count')
    input2 <- read.table(file_names[2], sep="\t", as.is=TRUE, header=FALSE)
    colnames(input2) <- c('gene_id', 'count')
    join_by <- c('gene_id', 'count')
  } else if (stringr::str_detect(file_names[1], pattern = 'flat.tsv$')){
    
    input1 <- read.table(file_names[1], sep="\t", as.is=TRUE, header=TRUE)
    input2 <- read.table(file_names[2], sep="\t", as.is=TRUE, header=TRUE)
    join_by <-  c('geneA.name', 'geneB.name', 'paircount', 'splitcount')
  } else if (stringr::str_detect(file_names[1], pattern = 'abundance.tsv$')){
    
    input1 <- read.table(file_names[1], sep="\t", as.is=TRUE, header=TRUE)
    input2 <- read.table(file_names[2], sep="\t", as.is=TRUE, header=TRUE)
    #merge both dataframes on target_id but only keep est_counts from second dataframe (and all cols from first dataframe)
    icombined <- merge(x = input1, y = input2[,c(1,4)], by = "target_id", all.x = TRUE)
    icombined_filterd <- data.frame(matrix(ncol = 6, nrow = 0))
    colnames(icombined_filterd) <- c('target_id',	'length',	'eff_length',	'est_counts_run1',	'tpm', 'est_counts_run2')
    for (i in 1:nrow(icombined)) {
      if (icombined[i,4] - icombined[i,6] > 2 || icombined[i,6] - icombined[i,4] > 2) {
        icombined_filterd <- rbind(icombined_filterd, icombined[i,])
      }
    }
    colnames(icombined_filterd) <- c('target_id',	'length',	'eff_length',	'est_counts_run1',	'tpm', 'est_counts_run2')
    icombined_filterd <- icombined_filterd[,c('target_id',	'length',	'eff_length',	'est_counts_run1',	'est_counts_run2', 'tpm')]
    return(icombined_filterd)
  }
  
  diff1 <- dplyr::anti_join(input1, input2, by = join_by) %>%
    mutate(input_info = 'bcbio_native') %>%
    dplyr::select(input_info, everything())
  
  diff2 <- dplyr::anti_join(input2, input1, by = join_by) %>%
    mutate(input_info = 'bcbio_cromwell') %>%
    dplyr::select(input_info, everything())
  
  return(rbind(diff1,diff2))
}

```


```{r, message=FALSE, warning=FALSE}
### Required packages.
library(tools)
library(DT)
library(dplyr)
library(kableExtra)
library(diffobj)
```

***

# List files

This section lists the file names for outputs in the run directories being compared in this report. 

```{r read_data, message=FALSE, warning=FALSE}
###Read input. 
###The script expects two input directories, each containing 'final' results as produced by bcbio. The results in these two input directories will be compared.
run_1 <-file.path(params$run_1)
#list files in the first run directory
lf(run_1)

run_2 <- file.path(params$run_2)
#list files in the second run directory
lf(run_2)

```

***

# Count

This section includes a summary of the total number of counts in the compared files and a table outlining difference between both runs.

```{r input-counts, message=FALSE, warning=FALSE}
###Start with the simple line count in the files i.e. the number of entries in the output from both runs is same.
#compare the count files first (from both runs)
counts_file_name <- dir(c(run_1, run_2), pattern = ".counts")
counts_file_name[1] <-  paste(run_1, counts_file_name[1], sep = "/")
counts_file_name[2] <-  paste(run_2, counts_file_name[2], sep = "/")
```

### Total counts

```{r total-counts, message=FALSE, warning=FALSE}
#functionc call for calculating number of lines in count files from both runs
lines_count <- countLines(counts_file_name)
datatable(lines_count, rownames = FALSE, options = list(sDom  = '<"top">lrt<"bottom">ip'))
```

### Diff counts

```{r diff-counts, message=FALSE, warning=FALSE}
#function call for finding the differences between count files from both runs
diff_count <- diffFiles(counts_file_name)
datatable(diff_count, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T))
```

***

# Abundance

This section includes a summary of the total number of abundance entries in the compared files and a table outlining difference between both runs.

```{r input-abundance, message=FALSE, warning=FALSE}
#compare the kallisto abundance calls (from both runs)
abundance_file_name <- dir(c(run_1, run_2), pattern = "abundance.tsv")
abundance_file_name[1] <-  paste(run_1, abundance_file_name[1], sep = "/")
abundance_file_name[2] <-  paste(run_2, abundance_file_name[2], sep = "/")
```

### Total abundance

```{r total-abundance, message=FALSE, warning=FALSE}
#functionc call for calculating number of lines in fusion files form both runs
lines_abundance <- countLines(abundance_file_name)
datatable(lines_abundance, rownames = FALSE, options = list(sDom  = '<"top">lrt<"bottom">ip'))
```

### Diff abundance

```{r diff-abundance, message=FALSE, warning=FALSE}
#function call for finding the differences between fusion calls from both runs
diff_abundance <- diffFiles(abundance_file_name)
datatable(diff_abundance, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T))

#read files
input1 <- read.table(abundance_file_name[1], sep="\t", as.is=TRUE, header=TRUE) %>%
      mutate_at(4, round, 0)
input2 <- read.table(abundance_file_name[2], sep="\t", as.is=TRUE, header=TRUE) %>%
      mutate_at(4, round, 0)
#check if target_id column have same values in both dataframes
if (identical(input1[,1], input2[,1])) {
  
}
```

***

# Fusions

This section includes a summary of the total number of fusions in the compared files and a table outlining difference between both runs.

```{r input-fusions, message=FALSE, warning=FALSE}
#compare the fusion calls (from both runs)
fusions_file_name <- dir(c(run_1, run_2), pattern = "flat.tsv")
fusions_file_name[1] <-  paste(run_1, fusions_file_name[1], sep = "/")
fusions_file_name[2] <-  paste(run_2, fusions_file_name[2], sep = "/")
```

### Total fusions

```{r total-fusions, message=FALSE, warning=FALSE}
#functionc call for calculating number of lines in fusion files form both runs
lines_fusion <- countLines(fusions_file_name)
datatable(lines_fusion, rownames = FALSE, options = list(sDom  = '<"top">lrt<"bottom">ip'))
```

### Diff fusions

```{r diff-fusions, message=FALSE, warning=FALSE}
#function call for finding the differences between fusion calls from both runs
diff_fusion <- diffFiles(fusions_file_name)
datatable(diff_fusion, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T))
```


***



